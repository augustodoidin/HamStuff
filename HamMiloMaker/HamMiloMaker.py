import os

def writeBEInt(number, file):
    file.write((number).to_bytes(4, "big"))

def writeBEString(string, file):
    stringLen = len(string)
    writeBEInt(stringLen, file)
    file.write(string.encode('utf8'))

def readFileToBinary(inputFile):
    file = open(inputFile, "rb")
    data = file.read()
    file.close()
    data += b'\xAD\xDE\xAD\xDE'
    return data

def writeObjDir(name, outputFile, inputFolder, moveDir = False):
    infoDir = {'clips': b'\x00\x00\x00\x4A\x00\x00\x02\xD2\x00', 'easy': b'\x00\x00\x00\x0E\x00\x00\x00\x66\x00', 'medium': b'\x00\x00\x00\x0E\x00\x00\x00\x6A\x00', 'expert': b'\x00\x00\x00\x0E\x00\x00\x00\x6A\x00', 'midi_bank': b'\x00\x00\x00\x16\x00\x00\x00\x9C\x00', 'moves': b'\x00\x00\x01\x36\x00\x00\x0D\x86\x00'}
    outputFile.write(readFileToBinary(inputFolder + f"{name}.milo"))
    objects = []
    if(moveDir == True):
        for dirFile in os.listdir(inputFolder + f"MoveDir\\{name}"):
            for dirsFile in os.listdir(inputFolder + f"MoveDir\\{name}\\{dirFile}"):
                objects.append({"type": dirFile, "name": dirsFile})
    else:
        for dirFile in os.listdir(inputFolder + f"ObjectDir\\{name}"):
            for dirsFile in os.listdir(inputFolder + f"ObjectDir\\{name}\\{dirFile}"):
                objects.append({"type": dirFile, "name": dirsFile})
    writeBEInt(32, file)
    if(moveDir == False):
        writeBEString("ObjectDir", file)
        writeBEString(f"{name}1", file)
        outputFile.write(infoDir[name])
        writeBEInt(len(objects), file)
    if(moveDir == True):
        writeBEString("MoveDir", file)
        writeBEString(f"{name}1", file)
        outputFile.write(infoDir[name])
        writeBEInt(len(objects)+1, file)
        writeBEString("ObjectDir", outputFile)
        writeBEString("barks", outputFile)
    for clip in objects:
        writeBEString(clip['type'], outputFile)
        writeBEString(clip['name'].replace("ASTERISCO", "*").replace("SETAPROLADO", ">"), outputFile)
    outputFile.write(readFileToBinary(inputFolder + f"{name}2.milo"))
    if(moveDir == True):
        outputFile.write(readFileToBinary(inputFolder + f"barks.milo"))
    for clip in objects:
        clipType = clip['type']
        clipName = clip['name']
        if(moveDir == True):
            outputFile.write(readFileToBinary(inputFolder + f"MoveDir\\{name}\\{clipType}\\{clipName}"))
        else:
            outputFile.write(readFileToBinary(inputFolder + f"ObjectDir\\{name}\\{clipType}\\{clipName}"))

def generateMilo(song, outputFile, inputFolder="input\\", hamVer="HAM2DLC"):
    if(hamVer == "HAM2DLC"):
        outputFile.write(b'\x00\x00\x00\x20\x00\x00\x00\x09\x4F\x62\x6A\x65\x63\x74\x44\x69\x72')
        writeBEString(song.lower(), outputFile)
        outputFile.write(b'\x00\x00\x00\x0E\x00\x00\x00\x30\x00\x00\x00\x00\x06\x00\x00\x00\x09\x4F\x62\x6A\x65\x63\x74\x44\x69\x72\x00\x00\x00\x05\x63\x6C\x69\x70\x73\x00\x00\x00\x09\x4F\x62\x6A\x65\x63\x74\x44\x69\x72\x00\x00\x00\x04\x65\x61\x73\x79\x00\x00\x00\x09\x4F\x62\x6A\x65\x63\x74\x44\x69\x72\x00\x00\x00\x06\x65\x78\x70\x65\x72\x74\x00\x00\x00\x09\x4F\x62\x6A\x65\x63\x74\x44\x69\x72\x00\x00\x00\x06\x6D\x65\x64\x69\x75\x6D\x00\x00\x00\x09\x4F\x62\x6A\x65\x63\x74\x44\x69\x72\x00\x00\x00\x09\x6D\x69\x64\x69\x5F\x62\x61\x6E\x6B\x00\x00\x00\x07\x4D\x6F\x76\x65\x44\x69\x72\x00\x00\x00\x05\x6D\x6F\x76\x65\x73\x00\x00\x00\x1C\x00\x00\x00\x02\x00\x00\x00\x04\x73\x6F\x6E\x67\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\x3F\x7E\x2D\xCD\xBD\xF3\x2F\x27\x32\x7F\xFB\xE1\x3D\x85\x53\x35\x3F\x0B\x5A\x52\xBF\x56\x13\x6E\x3D\xCB\x5B\xDF\x3F\x54\x8D\x94\x3F\x0C\x59\xEA\xC2\xBB\xB8\x64\xC3\xD3\x92\xA8\x44\x1B\x1E\x03\x00\x00\x00\x00\xBF\x80\x00\x00\x00\x00\x00\x00\x3F\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3F\x80\x00\x00\xC4\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3F\x80\x00\x00\x00\x00\x00\x00\xBF\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3F\x80\x00\x00\x44\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3F\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xBF\x80\x00\x00\x00\x00\x00\x00\x3F\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x44\x40\x00\x00\x3F\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3F\x80\x00\x00\x00\x00\x00\x00\xBF\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xC4\x40\x00\x00\x3F\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3F\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3F\x80\x00\x00\x00\x00\x00\x00\xC4\x40\x00\x00\x00\x00\x00\x00\xBF\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xBF\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3F\x80\x00\x00\x00\x00\x00\x00\x44\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xAD\xDE\xAD\xDE')
        writeObjDir("clips", outputFile, inputFolder)
        writeObjDir("easy", outputFile, inputFolder)
        writeObjDir("expert", outputFile, inputFolder)
        writeObjDir("medium", outputFile, inputFolder)
        writeObjDir("midi_bank", outputFile, inputFolder)
        writeObjDir("moves", outputFile, inputFolder, True)
        
        
    
